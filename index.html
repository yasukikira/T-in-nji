<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CYBER PROTOCOL V5 [3D]</title>
    <script src="https://unpkg.com/@discord/embedded-app-sdk@1.0.0/dist/discord-sdk.bundled.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <style>
        :root {
            --primary: #00f3ff;
            --secondary: #ff0055;
            --bg: #050510;
            --panel-bg: rgba(0, 10, 20, 0.9);
            --border: 1px solid rgba(0, 243, 255, 0.4);
        }

        body {
            background-color: var(--bg);
            color: var(--primary);
            font-family: "Courier New", Courier, monospace;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* --- 3D CANVAS --- */
        #canvas-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0;
        }

        /* --- VIGNETTE & SCANLINES --- */
        .overlay-fx {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: 
                linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            z-index: 1; pointer-events: none;
        }
        .vignette {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: radial-gradient(circle, transparent 50%, #000 100%);
            z-index: 2; pointer-events: none;
        }

        /* --- MAIN LAYOUT --- */
        #main-layout {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%; height: 100%;
            position: relative;
            z-index: 10;
            gap: 20px;
            padding: 20px;
            box-sizing: border-box;
        }

        /* --- PANELS --- */
        .side-panel {
            flex: 1; height: 80%;
            background: var(--panel-bg);
            border: var(--border);
            display: none; 
            flex-direction: column;
            padding: 15px;
            font-size: 0.8rem;
            color: #0aa;
            position: relative;
            backdrop-filter: blur(4px);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
        }
        @media (min-width: 900px) { .side-panel { display: flex; } }

        .panel-header { border-bottom: 1px solid var(--primary); margin-bottom: 10px; font-weight: bold; color: #fff; letter-spacing: 2px; }
        .log-content { flex: 1; overflow: hidden; opacity: 0.8; display: flex; flex-direction: column-reverse; }
        .log-line { margin-bottom: 4px; border-left: 2px solid var(--secondary); padding-left: 5px; }

        .console-wrapper { width: 100%; max-width: 500px; display: flex; flex-direction: column; align-items: center; }

        /* --- HUD --- */
        #ui-layer {
            width: 100%; display: flex; justify-content: space-between;
            background: var(--panel-bg); border: 1px solid var(--primary);
            padding: 15px; margin-bottom: 20px;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.15);
            backdrop-filter: blur(5px);
        }
        .stat-val { font-size: 1.4rem; font-weight: bold; text-shadow: 0 0 5px var(--primary); }

        /* --- SCREENS --- */
        .screen {
            background: var(--panel-bg); border: 1px solid var(--primary);
            width: 100%; padding: 30px 0;
            display: none; flex-direction: column; align-items: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            position: relative; backdrop-filter: blur(10px);
        }
        .screen.visible { display: flex; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* --- GRID --- */
        #grid-container { display: grid; gap: 8px; margin-bottom: 25px; }
        .cell {
            width: clamp(50px, 14vw, 80px); height: clamp(50px, 14vw, 80px);
            background: rgba(0, 243, 255, 0.05); border: 1px solid rgba(0, 243, 255, 0.5);
            cursor: pointer; transition: 0.1s;
        }
        .cell.active { 
            background: #fff; border-color: #fff; 
            box-shadow: 0 0 20px #fff, 0 0 40px var(--primary); 
            transform: scale(0.95); 
        }
        .cell.error { background: var(--secondary); border-color: var(--secondary); box-shadow: 0 0 20px var(--secondary); }

        /* --- CONTROLS --- */
        button {
            background: rgba(0, 243, 255, 0.15); color: var(--primary);
            border: 1px solid var(--primary); padding: 12px 30px;
            font-weight: bold; font-size: 1rem; text-transform: uppercase;
            cursor: pointer; transition: 0.2s; margin-top: 10px;
        }
        button:hover { background: var(--primary); color: #000; box-shadow: 0 0 20px var(--primary); }
        
        input, textarea {
            background: rgba(0,0,0,0.6); border: 1px solid #555; color: #fff;
            padding: 12px; width: 80%; text-align: center; margin: 10px 0;
            font-family: inherit; font-size: 1.1rem;
        }
        input:disabled { border-color: var(--primary); color: var(--primary); opacity: 0.8; }
        
        .discord-status { font-size: 0.8rem; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }
        .dot.online { background: #0f0; box-shadow: 0 0 5px #0f0; }

    </style>
</head>
<body>

    <div id="canvas-container"></div>
    
    <div class="overlay-fx"></div>
    <div class="vignette"></div>

    <div id="main-layout">
        
        <div class="side-panel left">
            <div class="panel-header">SYS_LOGS</div>
            <div class="log-content" id="sys-log">
                <div class="log-line">INIT_THREE_JS... OK</div>
                <div class="log-line">DISCORD_SDK... LOADING</div>
            </div>
        </div>

        <div class="console-wrapper">
            
            <div id="ui-layer">
                <div style="display:flex; flex-direction:column;">
                    <span style="font-size:0.7rem; color:#888;">CURRENT LVL</span>
                    <span class="stat-val" id="level-display">01</span>
                </div>
                <div style="display:flex; flex-direction:column; align-items:flex-end;">
                    <span style="font-size:0.7rem; color:#888;">PACKET PROGRESS</span>
                    <span class="stat-val" id="round-display">1/6</span>
                </div>
            </div>

            <div id="game-screen" class="screen visible">
                <div id="center-msg" style="font-size:1.2rem; margin-bottom:20px; font-weight:bold;">ESTABLISHING LINK...</div>
                <div id="grid-container"></div>
                <button id="start-btn">INITIALIZE</button>
            </div>

            <div id="reward-screen" class="screen">
                <h2 style="color:var(--secondary); margin:0">CONNECTION SEVERED</h2>
                <p id="end-reason" style="opacity:0.8; margin-bottom:20px;">SIGNAL LOST</p>
                
                <div style="background:rgba(255,255,255,0.05); border:1px solid #444; padding:15px; width:80%; margin-bottom:20px;">
                    <div style="font-size:0.8rem; color:#aaa;">LEVELS CLEARED</div>
                    <div id="final-level" style="font-size:2rem; color:#fff; font-weight:bold;">0</div>
                </div>

                <div class="discord-status">
                    <div id="discord-dot" class="dot"></div>
                    <span id="discord-status-text">DISCORD DISCONNECTED</span>
                </div>

                <input type="text" id="discord-id" placeholder="ENTER DISCORD ID" autocomplete="off">
                <div id="verify-error" style="color:var(--secondary); font-size:0.9rem; min-height:1.2em; margin-bottom:10px;"></div>
                
                <button id="gen-btn">GENERATE KEY</button>
                <button id="restart-btn" style="border-color:#555; color:#888; background:transparent; font-size:0.8rem; padding:8px 16px;">RETRY</button>
            </div>

            <div id="code-screen" class="screen">
                <h2 style="margin:0; color:var(--primary)">KEY GENERATED</h2>
                <textarea id="output-code" rows="4" readonly onclick="this.select()"></textarea>
                <button id="copy-btn">ðŸ“‹ COPY KEY</button>
                <button id="new-session-btn" style="margin-top:20px; border-color:#555;">NEW SESSION</button>
            </div>

        </div>

        <div class="side-panel right">
            <div class="panel-header">ENV_STATS</div>
            <div style="margin-top:10px; font-size:0.8rem;">
                RENDERER: WEBGL<br>
                FPS: <span id="fps-counter">60</span><br>
                GEOMETRY: 12k TRIS<br>
                <br>
                DISCORD_CLIENT:<br>
                <span id="discord-debug">NOT_DETECTED</span>
            </div>
        </div>

    </div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        // To enable real Discord Auth, you need a Client ID from the Discord Developer Portal.
        const DISCORD_CLIENT_ID = 'YOUR_DISCORD_CLIENT_ID_HERE'; 

        // ==========================================
        // 1. THREE.JS BACKGROUND SYSTEM
        // ==========================================
        const initThreeJS = () => {
            const container = document.getElementById('canvas-container');
            const scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x050510, 0.0025);

            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 50;
            camera.position.y = 10;
            camera.rotation.x = -0.2;

            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);

            // -- TERRAIN --
            const geometry = new THREE.PlaneGeometry(200, 200, 40, 40);
            const material = new THREE.MeshBasicMaterial({ 
                color: 0x00f3ff, 
                wireframe: true,
                transparent: true,
                opacity: 0.15
            });
            const terrain = new THREE.Mesh(geometry, material);
            terrain.rotation.x = -Math.PI / 2;
            scene.add(terrain);

            // -- PARTICLES --
            const particlesGeom = new THREE.BufferGeometry();
            const particlesCount = 300;
            const posArray = new Float32Array(particlesCount * 3);
            for(let i=0; i < particlesCount * 3; i++) {
                posArray[i] = (Math.random() - 0.5) * 150;
            }
            particlesGeom.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const particlesMat = new THREE.PointsMaterial({ size: 0.5, color: 0xff0055 });
            const particleMesh = new THREE.Points(particlesGeom, particlesMat);
            scene.add(particleMesh);

            // -- ANIMATION LOOP --
            let time = 0;
            const animate = () => {
                requestAnimationFrame(animate);
                time += 0.05;

                // Move terrain to simulate infinite scroll
                terrain.position.z = (time * 2) % 5;
                
                // Wiggle the terrain vertices for "cyber" effect
                const positions = terrain.geometry.attributes.position.array;
                for (let i = 0; i < positions.length; i += 3) {
                    // Only modify Z (height) based on X/Y
                    // Note: Since rotated, Z is height in local space
                    positions[i + 2] = Math.sin(positions[i]/10 + time) * 1.5 + Math.cos(positions[i+1]/10 + time) * 1.5;
                }
                terrain.geometry.attributes.position.needsUpdate = true;

                // Rotate particles slowly
                particleMesh.rotation.y = time * 0.05;

                renderer.render(scene, camera);
            };
            animate();

            // Resize Handler
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        };

        // ==========================================
        // 2. DISCORD SDK INTEGRATION
        // ==========================================
        let discordUser = null;
        
        const initDiscord = async () => {
            const statusText = document.getElementById('discord-status-text');
            const statusDot = document.getElementById('discord-dot');
            const debugText = document.getElementById('discord-debug');
            const log = document.getElementById('sys-log');

            try {
                // Check if running in iframe (likely Discord)
                if (window.self === window.top) {
                    throw new Error("NOT_IN_DISCORD");
                }

                const { DiscordSDK } = window.DiscordSDK;
                const discordSdk = new DiscordSDK(DISCORD_CLIENT_ID);

                await discordSdk.ready();
                
                // Authorize (This usually requires a backend to swap code for token)
                // For this Client-Only demo, we attempt a simple authorize command
                // Note: Without a backend, we might not get full user profile in production
                // This is the setup structure:
                const { code } = await discordSdk.commands.authorize({
                    client_id: DISCORD_CLIENT_ID,
                    response_type: "code",
                    state: "",
                    prompt: "none",
                    scope: [
                        "identify",
                        "rpc.activities.write"
                    ],
                });

                // Mocking user fetch success for logic demonstration
                // In a real app, you POST 'code' to your backend -> backend exchanges for token -> backend gets user
                statusText.innerText = "DISCORD LINKED (SDK)";
                statusDot.classList.add('online');
                debugText.innerText = "SDK_ACTIVE";
                
                // Add log
                const div = document.createElement('div');
                div.className = 'log-line'; div.innerText = "DISCORD_SDK: CONNECTED";
                log.prepend(div);

                // If we could really fetch user without backend (we can't easily), we would do it here.
                // For this demo, we will check if we can get instance data
                // discordUser = ...

            } catch (e) {
                console.log("Discord SDK Init failed or not in Discord:", e);
                statusText.innerText = "MANUAL OVERRIDE";
                debugText.innerText = "OFFLINE/BROWSER";
            }
        };

        // ==========================================
        // 3. GAME LOGIC (UNCHANGED BUT HOOKED UP)
        // ==========================================
        const Game = (() => {
            const CONFIG = { rounds: 6, speed: 600 };
            let state = { level: 1, round: 1, sequence: [], playerInput: [], isLocked: true, gridSize: 3 };
            
            // Audio Context
            let audioCtx = null;
            const initAudio = () => {
                if(!audioCtx) { try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){} }
                if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            };
            const playTone = (freq, type, dur) => {
                if(!audioCtx) return;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type; osc.frequency.value = freq; gain.gain.value = 0.05;
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(); osc.stop(audioCtx.currentTime + dur);
            };

            const els = {
                grid: document.getElementById('grid-container'),
                lvl: document.getElementById('level-display'),
                rnd: document.getElementById('round-display'),
                msg: document.getElementById('center-msg'),
                err: document.getElementById('verify-error')
            };

            const renderGrid = (size) => {
                els.grid.innerHTML = '';
                els.grid.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
                state.gridSize = size;
                for(let i=0; i<size*size; i++) {
                    const d = document.createElement('div');
                    d.className = 'cell';
                    d.onmousedown = (e) => { e.preventDefault(); handleInput(i); };
                    d.ontouchstart = (e) => { e.preventDefault(); handleInput(i); };
                    els.grid.appendChild(d);
                }
            };

            const startGame = () => {
                initAudio();
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('visible'));
                document.getElementById('game-screen').classList.add('visible');
                document.getElementById('start-btn').style.display = 'none';
                els.msg.innerText = "READY";
                state.level = 1; state.round = 1; state.sequence = [];
                els.lvl.innerText = "01"; els.rnd.innerText = "1/6";
                renderGrid(3);
                nextRound();
            };

            const nextRound = () => {
                state.playerInput = []; state.isLocked = true;
                if(state.level >= 6 && state.gridSize < 4) renderGrid(4);
                els.lvl.innerText = state.level.toString().padStart(2, '0');
                els.rnd.innerText = `${state.round}/${CONFIG.rounds}`;
                
                state.sequence.push(Math.floor(Math.random() * (state.gridSize * state.gridSize)));
                els.msg.innerText = "OBSERVE"; els.msg.style.color = "var(--primary)";
                
                let speed = Math.max(200, CONFIG.speed - (state.level * 15));
                setTimeout(() => playSequence(speed), 800);
            };

            const playSequence = async (speed) => {
                for(let id of state.sequence) {
                    await new Promise(r => {
                        const c = els.grid.children[id];
                        if(c) c.classList.add('active');
                        playTone(400 + (id*50), 'triangle', 0.1);
                        setTimeout(() => { if(c) c.classList.remove('active'); setTimeout(r, speed/2); }, speed/2);
                    });
                }
                state.isLocked = false; els.msg.innerText = "REPEAT";
            };

            const handleInput = (id) => {
                if(state.isLocked) return;
                const c = els.grid.children[id];
                c.classList.add('active');
                setTimeout(() => c.classList.remove('active'), 150);
                playTone(400 + (id*50), 'sine', 0.1);
                
                state.playerInput.push(id);
                if(state.playerInput[state.playerInput.length-1] !== state.sequence[state.playerInput.length-1]) {
                    gameOver(); return;
                }
                if(state.playerInput.length === state.sequence.length) {
                    state.isLocked = true;
                    if(state.round >= CONFIG.rounds) {
                        state.level++; state.round = 1; state.sequence = [];
                        els.msg.innerText = "UPLOADED"; 
                        setTimeout(nextRound, 1000);
                    } else {
                        state.round++; setTimeout(nextRound, 400);
                    }
                }
            };

            const gameOver = () => {
                state.isLocked = true; els.msg.innerText = "ERROR"; playTone(150, 'sawtooth', 0.5);
                document.querySelectorAll('.cell').forEach(c => c.classList.add('error'));
                setTimeout(() => {
                    document.getElementById('game-screen').classList.remove('visible');
                    document.getElementById('reward-screen').classList.add('visible');
                    document.getElementById('final-level').innerText = Math.max(0, state.level - 1);
                    document.getElementById('end-reason').innerText = `FAILED AT LVL ${state.level}`;
                }, 1000);
            };

            // Generating code logic
            document.getElementById('gen-btn').onclick = () => {
                const uid = document.getElementById('discord-id').value.trim();
                els.err.innerText = "";
                if(uid.length < 2) { els.err.innerText = "INVALID ID"; return; }
                if((state.level - 1) < 1) { els.err.innerText = "NO LEVELS CLEARED"; return; }

                const raw = `${uid}::${state.level-1}::${Date.now()}::CYBER_SECURE`;
                document.getElementById('output-code').value = btoa(raw);
                document.getElementById('reward-screen').classList.remove('visible');
                document.getElementById('code-screen').classList.add('visible');
            };

            // Misc Buttons
            document.getElementById('start-btn').onclick = startGame;
            document.getElementById('restart-btn').onclick = () => {
                document.getElementById('reward-screen').classList.remove('visible');
                document.getElementById('game-screen').classList.add('visible');
                startGame();
            };
            document.getElementById('new-session-btn').onclick = () => window.location.reload();
            document.getElementById('copy-btn').onclick = () => {
                const t = document.getElementById("output-code"); t.select();
                document.execCommand("copy");
            };

        })();

        // Boot Systems
        window.onload = () => {
            initThreeJS();
            initDiscord();
        };

    </script>
</body>
</html>
